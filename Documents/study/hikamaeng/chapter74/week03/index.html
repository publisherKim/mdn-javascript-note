<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>parser</title>
</head>
<body>
  <script>
    const textNode = (text, target) => {
      if(text.length){
        // target에 삽입
        target.push({type:'TEXT', text});
      }
      return text = '';
    };

    const elementNode = (input, cursor, text, stack, stacks) => {
      const char = input[cursor++];
      let isBreak = false;
      if(char === '<'){
        text = textNode(text, stack.tag.children);
        if(input[cursor++] !== '/'){
          let name = input.substring(cursor - 1, cursor = input.indexOf('>', cursor));
          const isClose = input[cursor] === '/';
          if(isClose) name = name.substr(0, name.length - 1);
          const tag = {name, type: 'NODE', children:[]};
          cursor++;
          stack.tag.children.push(tag);
          if(!isClose){
            stacks.push({tag, back: stack});
            isBreak = true;
          }
        }else if(stack.tag.name == input.substring(cursor, input.indexOf('>', cursor))) {
          stack = stack.back;
        }
      } else {
        text += char;
      }
      return {cursor, text, isBreak}
    };

    const parser = input => {
      const result = {tag:{type:'ROOT', children:[]}}, stacks = [];
      let cursor = 0, stack = result;
      do{
        let text = '';
        while(cursor < input.length){
          const v = elementNode(input, cursor, text, stack, stacks);
          ({cursor, text} = v);
          if(v.isBreak) break;
        }
      }while(stack = stacks.pop());
      return result.tag.children;
    };
    
    console.log('<div>test</div>', parser('<div>test</div>'));
    console.log('<div>test<img/></div>', parser('<div>test<img/></div>'));
    console.log('<div>test<a>aa</a>bb</div>', parser('<div>test<a>aa</a>bb</div>'));
  </script>
</body>
</html>